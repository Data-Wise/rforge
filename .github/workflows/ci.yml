name: RForge CI

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  validate:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required files
        run: |
          test -f .claude-plugin/plugin.json || { echo "Missing plugin.json"; exit 1; }
          test -f README.md || { echo "Missing README.md"; exit 1; }
          test -f package.json || { echo "Missing package.json"; exit 1; }
          test -f LICENSE || { echo "Missing LICENSE"; exit 1; }
          echo "âœ… All required files present"

      - name: Validate plugin.json
        run: |
          # Check if jq is available
          if ! command -v jq &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

          # Validate JSON syntax
          jq empty .claude-plugin/plugin.json || { echo "âŒ Invalid JSON in plugin.json"; exit 1; }

          # Check plugin name
          PLUGIN_NAME=$(jq -r '.name' .claude-plugin/plugin.json)
          if [[ "$PLUGIN_NAME" != "rforge" ]]; then
            echo "âŒ Plugin name should be 'rforge', got: $PLUGIN_NAME"
            exit 1
          fi

          # Check version exists
          VERSION=$(jq -r '.version' .claude-plugin/plugin.json)
          if [[ -z "$VERSION" || "$VERSION" == "null" ]]; then
            echo "âŒ Plugin version is missing"
            exit 1
          fi

          echo "âœ… plugin.json is valid (name: $PLUGIN_NAME, version: $VERSION)"

      - name: Check directory structure
        run: |
          test -d commands || { echo "âŒ Missing commands/ directory"; exit 1; }
          test -d agents || { echo "âŒ Missing agents/ directory"; exit 1; }
          test -d lib || { echo "âŒ Missing lib/ directory"; exit 1; }
          test -d docs || { echo "âŒ Missing docs/ directory"; exit 1; }
          test -d scripts || { echo "âŒ Missing scripts/ directory"; exit 1; }
          test -d tests || { echo "âŒ Missing tests/ directory"; exit 1; }
          echo "âœ… All required directories present"

      - name: Validate command count
        run: |
          COMMAND_COUNT=$(find commands -name "*.md" -type f | wc -l | tr -d ' ')
          if [ "$COMMAND_COUNT" -lt 15 ]; then
            echo "âŒ Expected at least 15 commands, found $COMMAND_COUNT"
            exit 1
          fi
          echo "âœ… Found $COMMAND_COUNT command files"

      - name: Check agents
        run: |
          test -f agents/orchestrator.md || { echo "âŒ Missing orchestrator agent"; exit 1; }
          echo "âœ… All agent files present"

      - name: Check for hardcoded paths
        run: |
          HARDCODED_PATHS=0
          if grep -r "/Users/" commands agents lib 2>/dev/null | grep -v "CLAUDE_PLUGIN_ROOT"; then
            echo "âŒ Found hardcoded /Users/ paths"
            HARDCODED_PATHS=1
          fi
          if grep -r "/home/" commands agents lib 2>/dev/null | grep -v "CLAUDE_PLUGIN_ROOT"; then
            echo "âŒ Found hardcoded /home/ paths"
            HARDCODED_PATHS=1
          fi
          if [ $HARDCODED_PATHS -eq 0 ]; then
            echo "âœ… No hardcoded paths found"
          else
            exit 1
          fi

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… All CI checks passed!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“Š Summary:"
          COMMAND_COUNT=$(find commands -name "*.md" -type f | wc -l | tr -d ' ')
          echo "  - Commands: $COMMAND_COUNT"
          echo "  - Agents: Orchestrator"
          echo "  - Structure: R package ecosystem management"
